<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventario - App con Login</title>

<!-- XLSX para exportaciones -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
/* ===== TU CSS ORIGINAL ===== */
:root{--primary:#860063;--accent:#f78c2a;--bg:#f2f2f2;--card:#fff;--text:#222;--success:#2d862d;--error:#cc0000;}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);min-height:100vh;scroll-behavior:smooth}
/* NAV */
nav{position:sticky;top:0;background:var(--primary);color:#fff;display:flex;gap:8px;padding:10px;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.12);flex-wrap:wrap}
nav button{background:#9a007d;color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;min-width:110px;max-width:170px;flex:1 1 auto;transition:all .18s}
nav button:hover{background:var(--accent)}
nav button.active{background:var(--accent);box-shadow:0 4px 8px rgba(0,0,0,.12)}
nav button.disabled{opacity:.45;cursor:not-allowed;pointer-events:none}
/* CONTAINER */
.container{max-width:920px;margin:16px auto;padding:0 12px 60px}
/* SECTION */
section{display:none;margin-top:12px}
section.active{display:block}
.section-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
.section-head h2{color:var(--primary);font-size:1.2rem}
/* CARD */
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);transition:transform .12s,box-shadow .12s}
.card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
/* FORMS */
label{display:block;font-size:.9rem;margin-bottom:6px;color:#444}
input[type="text"],input[type="number"],input[type="date"],select{width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;margin-bottom:12px;font-size:1rem}
input:focus,select:focus{outline:none;border:2px solid var(--primary)}
button.submitBtn{width:100%;padding:12px;background:var(--primary);color:#fff;border:0;border-radius:10px;cursor:pointer;font-weight:700}
button.exportBtn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
/* STOCK BADGE */
#stockActualCard{display:inline-block;padding:8px 10px;border-radius:10px;background:rgba(247,140,42,.15);font-weight:700;margin-bottom:10px}
/* TABLE */
.table-wrap{overflow:auto;border-radius:10px;border:1px solid #eee}
table{width:100%;border-collapse:collapse;min-width:420px}
thead th{background:var(--primary);color:#fff;padding:10px;text-align:left;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #f0f0f0}
/* TOAST */
#toast{position:fixed;top:18px;right:18px;z-index:9999;min-width:220px;padding:12px 16px;color:#fff;border-radius:10px;font-weight:700;box-shadow:0 8px 22px rgba(0,0,0,.12);transform:translateY(-20px);opacity:0;transition:all .25s}
#toast.show{transform:translateY(0);opacity:1}
#toast.success{background:var(--success)}
#toast.error{background:var(--error)}
/* LOGIN OVERLAY */
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:10000}
#loginCard{width:96%;max-width:420px;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.35)}
#loginCard h3{color:var(--primary);margin-bottom:12px}
.login-actions{display:flex;gap:10px;margin-top:12px}
.btn-ghost{background:transparent;border:1px solid #ddd;padding:10px;border-radius:8px;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff;border:0;padding:10px;border-radius:8px;cursor:pointer}
/* small */
@media(max-width:480px){
  nav button{max-width:100%}
  .section-head h2{font-size:1.05rem}
  th,td{font-size:.95rem}
}
</style>

</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" aria-hidden="false">
  <div id="loginCard" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="login-header">
      <div class="login-logo">IN</div>
      <div>
        <div id="loginTitle" class="login-title">Inventario — Acceso</div>
        <div class="login-sub">Inicia sesión para acceder a Entradas y Salidas</div>
      </div>
    </div>

    <div class="login-field">
      <input id="loginPassword" type="password" placeholder="Introduce la contraseña" autocomplete="current-password" />
      <div style="margin-top:6px"><span id="capsIndicator">MAYÚS</span></div>
    </div>

    <div class="login-actions">
      <button id="btnLogin" class="btn-primary" title="Entrar como administrador">Entrar</button>
      <button id="btnGuest" class="btn-ghost" title="Entrar como invitado (solo ver inventario)">Entrar sin usuario</button>
    </div>
    <div class="small-note">
      <strong>Nota:</strong> El modo Invitado solo permite visualizar el inventario.
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" role="status" aria-live="polite"></div>

<!-- NAV -->
<nav>
  <button id="navInventario" onclick="showTab('inventario')">Inventario</button>
  <button id="navEntrada" onclick="showTab('entrada')">Entrada</button>
  <button id="navSalida" onclick="showTab('salida')">Salida</button>
</nav>

<!-- APP CONTAINER -->
<div class="container">
  <!-- INVENTARIO -->
  <section id="inventario">
    <div class="section-head">
      <h2>Inventario Actual</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="filterInventario" type="text" placeholder="Filtrar por código o nombre" style="padding:10px;border-radius:8px;border:1px solid #ddd" oninput="mostrarInventario()" />
        <button class="exportBtn" id="exportInventarioBtn" onclick="exportExcelInventario()">Exportar Inventario</button>
      </div>
    </div>
    <div class="card">
      <div class="table-wrap" style="max-height:420px;overflow:auto">
        <table id="tablaInventario" aria-describedby="inventario">
          <thead><tr><th>Código</th><th>Nombre</th><th>Stock</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ENTRADA -->
  <section id="entrada">
    <div class="section-head">
      <h2>Entrada de Artículo</h2>
      <button class="exportBtn" id="exportEntradasBtn" onclick="exportExcelEntradas()">Exportar Entradas</button>
    </div>
    <div class="card">
      <form id="formEntrada" onsubmit="registrarEntrada(event)">
        <label for="entradaCodigo">Código (automático si nuevo)</label>
        <input id="entradaCodigo" type="text" placeholder="Código (dejar vacío para nuevo artículo)">
        <label for="entradaNombre">Nombre *</label>
        <input id="entradaNombre" type="text" placeholder="Nombre" required>
        <label for="entradaFecha">Fecha *</label>
        <input id="entradaFecha" type="date" required>
        <label for="entradaCantidad">Cantidad *</label>
        <input id="entradaCantidad" type="number" placeholder="Cantidad" min="1" required>
        <label for="entradaFactura">Número de factura</label>
        <input id="entradaFactura" type="text" maxlength="50" placeholder="Número de factura">
        <button type="submit" class="submitBtn" id="btnRegistrarEntrada">Registrar Entrada</button>
      </form>
    </div>
  </section>

  <!-- SALIDA -->
  <section id="salida">
    <div class="section-head">
      <h2>Salida de Artículo</h2>
      <button class="exportBtn" id="exportSalidasBtn" onclick="exportExcelSalidas()">Exportar Salidas</button>
    </div>
    <div class="card">
      <form id="formSalida" onsubmit="registrarSalida(event)">
        <label for="salidaCodigo">Código *</label>
        <input id="salidaCodigo" type="text" placeholder="Código" required oninput="autocompletarSalida()" />
        <label for="salidaNombre">Nombre</label>
        <input id="salidaNombre" type="text" readonly placeholder="Nombre" />
        <div id="stockActualCard">Stock actual: <span id="stockActual">0</span></div>
        <label for="salidaArea">Área / Encargado *</label>
        <input id="salidaArea" type="text" placeholder="Área / Encargado" required>
        <label for="salidaFecha">Fecha *</label>
        <input id="salidaFecha" type="date" required>
        <label for="salidaCantidad">Cantidad *</label>
        <input id="salidaCantidad" type="number" placeholder="Cantidad" min="1" required>
        <label for="salidaComentario">Comentario</label>
        <input id="salidaComentario" type="text" maxlength="200" placeholder="Comentario">
        <button type="submit" class="submitBtn" id="btnRegistrarSalida">Registrar Salida</button>
      </form>
    </div>
  </section>
</div>

<!-- ====== SCRIPT FIREBASE + LOGICA ====== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ========== CONFIG FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyBu3LlgZciPQuxY7ak9fUjPdCYkTqzExqQ",
  authDomain: "inventarioweb-cbde9.firebaseapp.com",
  projectId: "inventarioweb-cbde9",
  storageBucket: "inventarioweb-cbde9.firebasestorage.app",
  messagingSenderId: "491831879829",
  appId: "1:491831879829:web:0b598a41a73b88d973139c",
  measurementId: "G-X4G4N2KLLK"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

/* ========================= VARIABLES ========================= */
let role = 'locked';

/* ========================= LOGIN ========================= */
const loginOverlay = document.getElementById('loginOverlay');
const loginPassword = document.getElementById('loginPassword');
const btnLogin = document.getElementById('btnLogin');
const btnGuest = document.getElementById('btnGuest');

const ADMIN_PASSWORD = 'ofi123';

btnLogin.addEventListener('click', async ()=>{
  if(loginPassword.value===ADMIN_PASSWORD){
    role='admin';
    loginOverlay.style.display='none';
    await initAfterLogin();
    showToast('Acceso correcto. Bienvenido (Admin)','success');
  } else {
    showToast('Contraseña incorrecta','error');
  }
});

btnGuest.addEventListener('click', async ()=>{
  role='guest';
  loginOverlay.style.display='none';
  await initAfterLogin();
  showToast('Acceso como Invitado — Solo inventario','success');
});

/* ========================= FUNCIONES AUX ========================= */
const toast=document.getElementById('toast');
function showToast(msg,type='success'){ toast.textContent=msg; toast.className='show '+(type==='error'?'error':'success'); setTimeout(()=>{toast.className='';},3200); }

/* ========================= FUNCIONES FIRESTORE ========================= */
async function fetchArticulos(){
  const querySnapshot = await getDocs(collection(db,'articulos'));
  return querySnapshot.docs.map(d=>({id:d.id,...d.data()}));
}

async function fetchMovimientos(){
  const querySnapshot = await getDocs(collection(db,'movimientos'));
  return querySnapshot.docs.map(d=>({id:d.id,...d.data()}));
}

/* ========================= INICIALIZAR APP DESPUES DE LOGIN ========================= */
async function initAfterLogin(){
  showTab('inventario');
  const navEntrada = document.getElementById('navEntrada');
  const navSalida = document.getElementById('navSalida');
  const btnRegistrarEntrada = document.getElementById('btnRegistrarEntrada');
  const btnRegistrarSalida = document.getElementById('btnRegistrarSalida');
  const exportEntradasBtn = document.getElementById('exportEntradasBtn');
  const exportSalidasBtn = document.getElementById('exportSalidasBtn');
  const exportInventarioBtn = document.getElementById('exportInventarioBtn');

  if(role==='admin'){
    navEntrada.classList.remove('disabled'); navSalida.classList.remove('disabled');
    btnRegistrarEntrada.disabled=false; btnRegistrarSalida.disabled=false;
    exportEntradasBtn.disabled=false; exportSalidasBtn.disabled=false; exportInventarioBtn.disabled=false;
    navEntrada.style.display=''; navSalida.style.display='';
  } else {
    navEntrada.classList.add('disabled'); navSalida.classList.add('disabled');
    btnRegistrarEntrada.disabled=true; btnRegistrarSalida.disabled=true;
    exportEntradasBtn.disabled=true; exportSalidasBtn.disabled=true; exportInventarioBtn.disabled=false;
    navEntrada.style.display='none'; navSalida.style.display='none';
  }

  // Cargar datos desde Firestore
  window.articulos = await fetchArticulos();
  window.movimientos = await fetchMovimientos();
  mostrarInventario();
}

/* ========================= NAV / TABS ========================= */
function showTab(tab){
  if(role==='guest' && (tab==='entrada'||tab==='salida')){ showToast('Acceso denegado. Modo Invitado: solo Inventario','error'); tab='inventario'; }
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(tab); if(el) el.classList.add('active');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  const navButtons=document.querySelectorAll('nav button');
  navButtons.forEach(nb=>{ if(nb.getAttribute('onclick') && nb.getAttribute('onclick').includes(tab)){ nb.classList.add('active'); } });
}

/* ========================= INVENTARIO ========================= */
async function mostrarInventario(){
  const tbody=document.querySelector('#tablaInventario tbody');
  const filterText=(document.getElementById('filterInventario')?.value||'').toLowerCase();
  tbody.innerHTML='';
  const list = window.articulos
    .filter(a=>!filterText||a.codigo.toLowerCase().includes(filterText)||a.nombre.toLowerCase().includes(filterText))
    .sort((x,y)=>x.codigo.localeCompare(y.codigo));
  list.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.codigo}</td><td>${a.nombre}</td><td>${a.stock}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========================= GENERAR CODIGO ========================= */
function generarCodigo(){
  let max=0; window.articulos.forEach(a=>{ if(a.codigo.startsWith('AP')){ const n=parseInt(a.codigo.slice(2),10); if(!isNaN(n)&&n>max) max=n; }});
  max++; return 'AP'+String(max).padStart(3,'0');
}

/* ========================= REGISTRAR ENTRADA ========================= */
async function registrarEntrada(e){
  e?.preventDefault();
  if(role!=='admin'){ showToast('No autorizado en modo Invitado','error'); return; }
  const codigoInput=document.getElementById('entradaCodigo');
  const nombreInput=document.getElementById('entradaNombre');
  const fechaInput=document.getElementById('entradaFecha');
  const cantidadInput=document.getElementById('entradaCantidad');
  const facturaInput=document.getElementById('entradaFactura');

  let codigo=codigoInput.value.trim();
  const nombre=nombreInput.value.trim();
  const fecha=fechaInput.value;
  const cantidad=parseInt(cantidadInput.value,10);
  const factura=facturaInput.value.trim();

  if(!nombre||!fecha||Number.isNaN(cantidad)||cantidad<=0){ showToast('Complete todos los campos correctamente.','error'); return; }

  let articulo=window.articulos.find(a=>a.codigo===codigo || a.nombre.toLowerCase()===nombre.toLowerCase());
  if(!articulo){
    codigo = codigo || generarCodigo();
    articulo={codigo,nombre,stock:cantidad};
    const docRef = await addDoc(collection(db,'articulos'),articulo);
    articulo.id = docRef.id;
    window.articulos.push(articulo);
  } else {
    articulo.stock += cantidad;
    const docRef = doc(db,'articulos',articulo.id);
    await updateDoc(docRef,{stock:articulo.stock});
  }

  const movimiento={
    tipo:'entrada', codigo:articulo.codigo, nombre:articulo.nombre, cantidad, fecha, factura
  };
  await addDoc(collection(db,'movimientos'),movimiento);
  window.movimientos.push(movimiento);

  codigoInput.value=''; nombreInput.value=''; fechaInput.value=''; cantidadInput.value=''; facturaInput.value='';
  mostrarInventario();
  showToast('Entrada registrada correctamente','success');
}

/* ========================= REGISTRAR SALIDA ========================= */
async function registrarSalida(e){
  e?.preventDefault();
  if(role!=='admin'){ showToast('No autorizado en modo Invitado','error'); return; }
  const codigoInput=document.getElementById('salidaCodigo');
  const nombreInput=document.getElementById('salidaNombre');
  const cantidadInput=document.getElementById('salidaCantidad');
  const areaInput=document.getElementById('salidaArea');
  const fechaInput=document.getElementById('salidaFecha');
  const comentarioInput=document.getElementById('salidaComentario');
  const stockCard=document.getElementById('stockActual');

  const codigo=codigoInput.value.trim();
  const articulo=window.articulos.find(a=>a.codigo===codigo);
  if(!articulo){ showToast('Código no encontrado','error'); return; }
  const cantidad=parseInt(cantidadInput.value,10);
  if(Number.isNaN(cantidad)||cantidad<=0){ showToast('Cantidad inválida','error'); return; }
  if(cantidad>articulo.stock){ showToast('Stock insuficiente','error'); return; }

  articulo.stock -= cantidad;
  const docRef = doc(db,'articulos',articulo.id);
  await updateDoc(docRef,{stock:articulo.stock});

  const movimiento={
    tipo:'salida', codigo:articulo.codigo, nombre:articulo.nombre,
    cantidad, fecha:fechaInput.value, area:areaInput.value.trim(), comentario:comentarioInput.value.trim()
  };
  await addDoc(collection(db,'movimientos'),movimiento);
  window.movimientos.push(movimiento);

  codigoInput.value=''; nombreInput.value=''; cantidadInput.value=''; areaInput.value=''; fechaInput.value=''; comentarioInput.value='';
  stockCard.textContent='0';
  mostrarInventario();
  showToast('Salida registrada correctamente','success');
}

/* ========================= AUTOCOMPLETAR SALIDA ========================= */
function autocompletarSalida(){
  const codigo=document.getElementById('salidaCodigo').value.trim();
  const nombreInput=document.getElementById('salidaNombre');
  const stockCard=document.getElementById('stockActual');
  const articulo=window.articulos.find(a=>a.codigo===codigo);
  if(articulo){ nombreInput.value=articulo.nombre; stockCard.textContent=articulo.stock; } else { nombreInput.value=''; stockCard.textContent='0'; }
}

/* ========================= EXPORTAR A EXCEL ========================= */
function exportExcelInventario(){
  const data=window.articulos.map(a=>({Codigo:a.codigo,Nombre:a.nombre,Stock:a.stock}));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Inventario');
  XLSX.writeFile(wb,'Inventario.xlsx');
}

function exportExcelEntradas(){
  const data=window.movimientos.filter(m=>m.tipo==='entrada');
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Entradas');
  XLSX.writeFile(wb,'Entradas.xlsx');
}

function exportExcelSalidas(){
  const data=window.movimientos.filter(m=>m.tipo==='salida');
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Salidas');
  XLSX.writeFile(wb,'Salidas.xlsx');
}

</script>

</body>
</html>
