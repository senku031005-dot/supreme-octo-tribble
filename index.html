<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventario - App con Login</title>
<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root{--primary:#860063;--accent:#f78c2a;--bg:#f2f2f2;--card:#fff;--text:#222;--success:#2d862d;--error:#cc0000}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);min-height:100vh;scroll-behavior:smooth}
/* NAV */
nav{position:sticky;top:0;background:var(--primary);color:#fff;display:flex;gap:8px;padding:10px;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.12);flex-wrap:wrap}
nav button{background:#9a007d;color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;min-width:110px;max-width:170px;flex:1 1 auto;transition:all .18s}
nav button:hover{background:var(--accent)}
nav button.active{background:var(--accent);box-shadow:0 4px 8px rgba(0,0,0,.12)}
nav button.disabled{opacity:.45;cursor:not-allowed;pointer-events:none}
/* CONTAINER */
.container{max-width:920px;margin:16px auto;padding:0 12px 60px}
/* SECTION */
section{display:none;margin-top:12px}
section.active{display:block}
.section-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
.section-head h2{color:var(--primary);font-size:1.2rem}
/* CARD */
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);transition:transform .12s,box-shadow .12s}
.card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
/* FORMS */
label{display:block;font-size:.9rem;margin-bottom:6px;color:#444}
input[type="text"],input[type="number"],input[type="date"],select{width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;margin-bottom:12px;font-size:1rem}
input:focus,select:focus{outline:none;border:2px solid var(--primary)}
button.submitBtn{width:100%;padding:12px;background:var(--primary);color:#fff;border:0;border-radius:10px;cursor:pointer;font-weight:700}
button.exportBtn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
/* STOCK BADGE */
#stockActualCard{display:inline-block;padding:8px 10px;border-radius:10px;background:rgba(247,140,42,.15);font-weight:700;margin-bottom:10px}
/* TABLE */
.table-wrap{overflow:auto;border-radius:10px;border:1px solid #eee}
table{width:100%;border-collapse:collapse;min-width:420px}
thead th{background:var(--primary);color:#fff;padding:10px;text-align:left;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #f0f0f0}
/* TOAST */
#toast{position:fixed;top:18px;right:18px;z-index:9999;min-width:220px;padding:12px 16px;color:#fff;border-radius:10px;font-weight:700;box-shadow:0 8px 22px rgba(0,0,0,.12);transform:translateY(-20px);opacity:0;transition:all .25s}
#toast.show{transform:translateY(0);opacity:1}
#toast.success{background:var(--success)}
#toast.error{background:var(--error)}
/* LOGIN OVERLAY */
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:10000}
#loginCard{width:96%;max-width:420px;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.35)}
#loginCard h3{color:var(--primary);margin-bottom:12px}
.login-actions{display:flex;gap:10px;margin-top:12px}
.btn-ghost{background:transparent;border:1px solid #ddd;padding:10px;border-radius:8px;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff;border:0;padding:10px;border-radius:8px;cursor:pointer}
/* small */
@media(max-width:480px){ nav button{max-width:100%} .section-head h2{font-size:1.05rem} th,td{font-size:.95rem} }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div id="loginCard">
    <h3>Inventario — Acceso</h3>
    <input id="loginPassword" type="password" placeholder="Introduce la contraseña">
    <div class="login-actions">
      <button id="btnLogin" class="btn-primary">Entrar</button>
      <button id="btnGuest" class="btn-ghost">Entrar sin usuario</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- NAV -->
<nav>
  <button id="navInventario" onclick="showTab('inventario')">Inventario</button>
  <button id="navEntrada" onclick="showTab('entrada')">Entrada</button>
  <button id="navSalida" onclick="showTab('salida')">Salida</button>
</nav>

<!-- APP CONTAINER -->
<div class="container">
  <!-- INVENTARIO -->
  <section id="inventario">
    <div class="section-head">
      <h2>Inventario Actual</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="filterInventario" type="text" placeholder="Filtrar por código o nombre" oninput="mostrarInventario()">
        <button class="exportBtn" id="exportInventarioBtn" onclick="exportExcelInventario()">Exportar Inventario</button>
      </div>
    </div>
    <div class="card">
      <div class="table-wrap">
        <table id="tablaInventario">
          <thead><tr><th>Código</th><th>Nombre</th><th>Stock</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ENTRADA -->
  <section id="entrada">
    <div class="section-head">
      <h2>Entrada de Artículo</h2>
      <button class="exportBtn" id="exportEntradasBtn" onclick="exportExcelEntradas()">Exportar Entradas</button>
    </div>
    <div class="card">
      <form id="formEntrada" onsubmit="registrarEntrada(event)">
        <label>Código (automático si nuevo)</label>
        <input id="entradaCodigo" type="text">
        <label>Nombre *</label>
        <input id="entradaNombre" type="text" required>
        <label>Fecha *</label>
        <input id="entradaFecha" type="date" required>
        <label>Cantidad *</label>
        <input id="entradaCantidad" type="number" min="1" required>
        <label>Número de factura</label>
        <input id="entradaFactura" type="text" maxlength="50">
        <button type="submit" class="submitBtn" id="btnRegistrarEntrada">Registrar Entrada</button>
      </form>
    </div>
  </section>

  <!-- SALIDA -->
  <section id="salida">
    <div class="section-head">
      <h2>Salida de Artículo</h2>
      <button class="exportBtn" id="exportSalidasBtn" onclick="exportExcelSalidas()">Exportar Salidas</button>
    </div>
    <div class="card">
      <form id="formSalida" onsubmit="registrarSalida(event)">
        <label>Código *</label>
        <input id="salidaCodigo" type="text" required oninput="autocompletarSalida()">
        <label>Nombre</label>
        <input id="salidaNombre" type="text" readonly>
        <div id="stockActualCard">Stock actual: <span id="stockActual">0</span></div>
        <label>Área / Encargado *</label>
        <input id="salidaArea" type="text" required>
        <label>Fecha *</label>
        <input id="salidaFecha" type="date" required>
        <label>Cantidad *</label>
        <input id="salidaCantidad" type="number" min="1" required>
        <label>Comentario</label>
        <input id="salidaComentario" type="text" maxlength="200">
        <button type="submit" class="submitBtn" id="btnRegistrarSalida">Registrar Salida</button>
      </form>
    </div>
  </section>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ========================= CONFIG FIREBASE ========================= */
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_PROYECTO.firebaseapp.com",
  projectId: "TU_PROYECTO",
  storageBucket: "TU_PROYECTO.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========================= CONFIG APP ========================= */
const ADMIN_PASSWORD = 'ofi123';
let role = 'locked';
const loginOverlay = document.getElementById('loginOverlay');
const btnLogin = document.getElementById('btnLogin');
const btnGuest = document.getElementById('btnGuest');
const loginPassword = document.getElementById('loginPassword');
const toast = document.getElementById('toast');

/* ========================= TOAST ========================= */
function showToast(msg, type='success'){
  toast.textContent = msg;
  toast.className = 'show ' + (type==='error'?'error':'success');
  setTimeout(()=>{toast.className='';},3200);
}

/* ========================= LOGIN ========================= */
btnLogin.addEventListener('click', async () => {
  const pwd = loginPassword.value || '';
  if(pwd === ADMIN_PASSWORD){
    role='admin';
    loginOverlay.style.display='none';
    await initAfterLogin();
    showToast('Acceso correcto. Bienvenido (Admin)','success');
  } else {
    showToast('Contraseña incorrecta','error');
  }
});
btnGuest.addEventListener('click', async () => {
  role='guest';
  loginOverlay.style.display='none';
  await initAfterLogin();
  showToast('Acceso como Invitado — Solo inventario','success');
});

/* ========================= INICIALIZAR APP ========================= */
async function initAfterLogin(){
  showTab('inventario');
  const navEntrada = document.getElementById('navEntrada');
  const navSalida = document.getElementById('navSalida');
  const btnRegistrarEntrada = document.getElementById('btnRegistrarEntrada');
  const btnRegistrarSalida = document.getElementById('btnRegistrarSalida');
  const exportEntradasBtn = document.getElementById('exportEntradasBtn');
  const exportSalidasBtn = document.getElementById('exportSalidasBtn');
  const exportInventarioBtn = document.getElementById('exportInventarioBtn');

  if(role==='admin'){
    navEntrada.classList.remove('disabled'); navSalida.classList.remove('disabled');
    btnRegistrarEntrada.disabled=false; btnRegistrarSalida.disabled=false;
    exportEntradasBtn.disabled=false; exportSalidasBtn.disabled=false; exportInventarioBtn.disabled=false;
    navEntrada.style.display=''; navSalida.style.display='';
  } else {
    navEntrada.classList.add('disabled'); navSalida.classList.add('disabled');
    btnRegistrarEntrada.disabled=true; btnRegistrarSalida.disabled=true;
    exportEntradasBtn.disabled=true; exportSalidasBtn.disabled=true; exportInventarioBtn.disabled=false;
    navEntrada.style.display='none'; navSalida.style.display='none';
  }

  // Cargar inventario desde Firebase
  await mostrarInventario();
}

/* ========================= NAV / TABS ========================= */
function showTab(tab){
  if(role==='guest' && (tab==='entrada'||tab==='salida')){
    showToast('Acceso denegado. Modo Invitado: solo Inventario','error');
    tab='inventario';
  }
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(tab);
  if(el) el.classList.add('active');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  const navButtons=document.querySelectorAll('nav button');
  navButtons.forEach(nb=>{if(nb.getAttribute('onclick')?.includes(tab)) nb.classList.add('active');});
}

/* ========================= INVENTARIO ========================= */
async function mostrarInventario(){
  const tbody = document.querySelector('#tablaInventario tbody');
  const filterText = (document.getElementById('filterInventario')?.value || '').toLowerCase();
  tbody.innerHTML='';

  const snapshot = await db.collection('articulos').get();
  snapshot.forEach(doc=>{
    const a = doc.data();
    if(filterText && !(a.codigo.toLowerCase().includes(filterText) || a.nombre.toLowerCase().includes(filterText))) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.codigo}</td><td>${a.nombre}</td><td>${a.stock}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========================= GENERAR CODIGO ========================= */
async function generarCodigo(){
  const snapshot = await db.collection('articulos').orderBy('codigo','desc').limit(1).get();
  let max = 0;
  snapshot.forEach(doc=>{
    const c = doc.data().codigo;
    if(c.startsWith('AP')){
      const n=parseInt(c.slice(2),10);
      if(!isNaN(n) && n>max) max=n;
    }
  });
  max++;
  return 'AP'+String(max).padStart(3,'0');
}

/* ========================= REGISTRAR ENTRADA ========================= */
async function registrarEntrada(e){
  e?.preventDefault();
  if(role!=='admin'){ showToast('No autorizado en modo Invitado','error'); return; }
  let codigo = document.getElementById('entradaCodigo').value.trim();
  const nombre = document.getElementById('entradaNombre').value.trim();
  const fecha = document.getElementById('entradaFecha').value;
  const cantidad = parseInt(document.getElementById('entradaCantidad').value,10);
  const factura = document.getElementById('entradaFactura').value.trim();

  if(!nombre || !fecha || isNaN(cantidad) || cantidad<=0){ showToast('Complete todos los campos correctamente.','error'); return; }
  if(new Date(fecha) > new Date()){ showToast('La fecha no puede ser futura.','error'); return; }

  if(!codigo) codigo = await generarCodigo();
  const artRef = db.collection('articulos').doc(codigo);
  const doc = await artRef.get();

  let stockResultante = cantidad;
  if(doc.exists){
    const data = doc.data();
    if(data.nombre!==nombre){ showToast('Código ya existe para otro artículo','error'); return; }
    stockResultante = data.stock + cantidad;
    await artRef.update({stock: stockResultante});
  } else {
    await artRef.set({codigo, nombre, stock:stockResultante});
  }

  await db.collection('movimientos').add({
    timestamp: new Date().toISOString(),
    tipo:'Entrada',
    codigo, nombre, cantidad,
    fechaMovimiento: fecha,
    numeroFactura: factura||'',
    stockResultante
  });

  showToast(`Entrada registrada ✅ Código: ${codigo}`,'success');
  document.getElementById('formEntrada').reset();
  document.getElementById('entradaFecha').value=new Date().toISOString().split('T')[0];
  await mostrarInventario();
}

/* ========================= SALIDA ========================= */
async function autocompletarSalida(){
  const code = document.getElementById('salidaCodigo').value.trim();
  if(!code) return;
  const doc = await db.collection('articulos').doc(code).get();
  if(doc.exists){
    const a=doc.data();
    document.getElementById('salidaNombre').value=a.nombre;
    document.getElementById('stockActual').textContent=a.stock;
  } else {
    document.getElementById('salidaNombre').value='';
    document.getElementById('stockActual').textContent=0;
  }
}

async function registrarSalida(e){
  e?.preventDefault();
  if(role!=='admin'){ showToast('No autorizado en modo Invitado','error'); return; }
  const codigo = document.getElementById('salidaCodigo').value.trim();
  const area = document.getElementById('salidaArea').value.trim();
  const fecha = document.getElementById('salidaFecha').value;
  const cantidad = parseInt(document.getElementById('salidaCantidad').value,10);
  const comentario = document.getElementById('salidaComentario').value.trim();

  if(!codigo || !area || !fecha || isNaN(cantidad) || cantidad<=0){ showToast('Complete todos los campos correctamente.','error'); return; }
  if(new Date(fecha) > new Date()){ showToast('La fecha no puede ser futura.','error'); return; }

  const artRef = db.collection('articulos').doc(codigo);
  const doc = await artRef.get();
  if(!doc.exists){ showToast('Código no existe','error'); return; }

  const art = doc.data();
  if(cantidad > art.stock){ showToast('Cantidad excede stock','error'); return; }

  const stockResultante = art.stock - cantidad;
  await artRef.update({stock: stockResultante});
  document.getElementById('stockActual').textContent = stockResultante;

  await db.collection('movimientos').add({
    timestamp: new Date().toISOString(),
    tipo:'Salida',
    codigo,
    nombre: art.nombre,
    cantidad,
    areaEncargado: area,
    fechaMovimiento: fecha,
    comentario,
    stockResultante
  });

  showToast('Salida registrada ✅','success');
  document.getElementById('formSalida').reset();
  document.getElementById('salidaFecha').value=new Date().toISOString().split('T')[0];
  await mostrarInventario();
}

/* ========================= EXPORTS ========================= */
async function exportExcelInventario(){
  const snapshot = await db.collection('articulos').get();
  const list = snapshot.docs.map(doc=>doc.data());
  if(list.length===0){ showToast('No hay artículos para exportar','error'); return; }
  const ws_data = list.map(a=>[a.codigo,a.nombre,a.stock]);
  ws_data.unshift(['Código','Nombre','Stock']);
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Inventario');
  XLSX.writeFile(wb,`inventario_${new Date().toISOString().slice(0,10)}.xlsx`);
}
async function exportExcelEntradas(){
  const snapshot = await db.collection('movimientos').where('tipo','==','Entrada').get();
  const list = snapshot.docs.map(doc=>doc.data());
  if(list.length===0){ showToast('No hay entradas para exportar','error'); return; }
  const ws_data = list.map(m=>[m.timestamp,m.tipo,m.codigo,m.nombre,m.cantidad,m.fechaMovimiento,m.numeroFactura,m.stockResultante]);
  ws_data.unshift(['Timestamp','Tipo','Código','Nombre','Cantidad','FechaMovimiento','NumeroFactura','StockResultante']);
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Entradas');
  XLSX.writeFile(wb,`entradas_${new Date().toISOString().slice(0,10)}.xlsx`);
}
async function exportExcelSalidas(){
  const snapshot = await db.collection('movimientos').where('tipo','==','Salida').get();
  const list = snapshot.docs.map(doc=>doc.data());
  if(list.length===0){ showToast('No hay salidas para exportar','error'); return; }
  const ws_data = list.map(m=>[m.timestamp,m.tipo,m.codigo,m.nombre,m.cantidad,m.areaEncargado,m.fechaMovimiento,m.comentario,m.stockResultante]);
  ws_data.unshift(['Timestamp','Tipo','Código','Nombre','Cantidad','ÁreaEncargado','FechaMovimiento','Comentario','StockResultante']);
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Salidas');
  XLSX.writeFile(wb,`salidas_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* ========================= INIT FECHAS ========================= */
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('entradaFecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('salidaFecha').value=new Date().toISOString().split('T')[0];
});
</script>

</body>
</html>
