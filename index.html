<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventario - App con Firebase y Login</title>
<!-- Incluye XLSX para exportar Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* Estilos mínimos para toast y overlay */
#toast {position: fixed; bottom: 20px; left:50%; transform: translateX(-50%); padding:10px 20px; border-radius:5px; display:none; color:#fff;}
#toast.show {display:block;}
#toast.success {background:green;}
#toast.error {background:red;}
#loginOverlay {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:1000;}
#loginOverlay .box {background:#fff; padding:20px; border-radius:5px;}
</style>
</head>
<body>

<div id="loginOverlay">
  <div class="box">
    <h3>Login Admin</h3>
    <input type="password" id="loginPassword" placeholder="Contraseña web">
    <button id="btnLogin">Entrar</button>
    <button id="btnGuest">Invitado</button>
  </div>
</div>

<div id="toast"></div>

<nav>
  <button onclick="showTab('inventario')">Inventario</button>
  <button id="navEntrada" onclick="showTab('entrada')">Entrada</button>
  <button id="navSalida" onclick="showTab('salida')">Salida</button>
</nav>

<section id="inventario" class="active">
  <h2>Inventario</h2>
  <input id="filterInventario" placeholder="Buscar...">
  <table id="tablaInventario">
    <thead><tr><th>Código</th><th>Nombre</th><th>Stock</th></tr></thead>
    <tbody></tbody>
  </table>
  <button onclick="exportExcelInventario()">Exportar Inventario</button>
</section>

<section id="entrada">
  <h2>Registrar Entrada</h2>
  <form id="formEntrada" onsubmit="registrarEntrada(event)">
    <input id="entradaCodigo" placeholder="Código (dejar vacío para generar)">
    <input id="entradaNombre" placeholder="Nombre">
    <input id="entradaFecha" type="date">
    <input id="entradaCantidad" type="number" placeholder="Cantidad">
    <input id="entradaFactura" placeholder="Factura">
    <button type="submit" id="btnRegistrarEntrada">Registrar Entrada</button>
  </form>
  <button onclick="exportExcelEntradas()" id="exportEntradasBtn">Exportar Entradas</button>
</section>

<section id="salida">
  <h2>Registrar Salida</h2>
  <form id="formSalida" onsubmit="registrarSalida(event)">
    <input id="salidaCodigo" placeholder="Código" oninput="autocompletarSalida()">
    <input id="salidaNombre" placeholder="Nombre" readonly>
    <span>Stock actual: <span id="stockActual">0</span></span>
    <input id="salidaArea" placeholder="Área encargado">
    <input id="salidaFecha" type="date">
    <input id="salidaCantidad" type="number" placeholder="Cantidad">
    <input id="salidaComentario" placeholder="Comentario">
    <button type="submit" id="btnRegistrarSalida">Registrar Salida</button>
  </form>
  <button onclick="exportExcelSalidas()" id="exportSalidasBtn">Exportar Salidas</button>
</section>

<script type="module">
/* ===========================
   Firebase Firestore
   =========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, doc, getDocs, setDoc, runTransaction, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_PROYECTO.firebaseapp.com",
  projectId: "TU_PROYECTO",
  storageBucket: "TU_PROYECTO.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===========================
   Login web y estado de usuario
   =========================== */
const ADMIN_PASSWORD = 'ofi123';
let role = 'locked'; // 'locked' | 'guest' | 'admin'

let loginOverlay, btnLogin, btnGuest, loginPassword, toastElem;

document.addEventListener('DOMContentLoaded', () => {
  loginOverlay = document.getElementById('loginOverlay');
  btnLogin = document.getElementById('btnLogin');
  btnGuest = document.getElementById('btnGuest');
  loginPassword = document.getElementById('loginPassword');
  toastElem = document.getElementById('toast');

  btnGuest.addEventListener('click', () => {
    role = 'guest';
    loginOverlay.style.display = 'none';
    initAfterLogin();
    showToast('Acceso como Invitado — Solo inventario','success');
  });

  btnLogin.addEventListener('click', () => {
    const pwd = loginPassword.value || '';
    if(pwd === ADMIN_PASSWORD){
      role = 'admin';
      loginOverlay.style.display = 'none';
      initAfterLogin();
      showToast('Acceso correcto. Bienvenido (Admin)','success');
    } else showToast('Contraseña incorrecta','error');
  });

  // Inicializar fechas
  document.getElementById('entradaFecha').value = new Date().toISOString().split('T')[0];
  document.getElementById('salidaFecha').value = new Date().toISOString().split('T')[0];
});

/* ===========================
   Funciones de UI
   =========================== */
function showToast(msg, type='success'){
  toastElem.textContent = msg;
  toastElem.className = 'show ' + (type==='error'?'error':'success');
  setTimeout(()=>{ toastElem.className=''; }, 3200);
}

function showTab(tab){
  if(role==='guest' && (tab==='entrada'||tab==='salida')){ showToast('Acceso denegado. Modo Invitado: solo Inventario','error'); tab='inventario'; }
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab)?.classList.add('active');
  document.querySelectorAll('nav button').forEach(b=>{
    if(b.getAttribute('onclick') && b.getAttribute('onclick').includes(tab)) b.classList.add('active');
    else b.classList.remove('active');
  });
}

/* ===========================
   Inicialización después de login
   =========================== */
function initAfterLogin(){
  showTab('inventario');
  const navEntrada = document.getElementById('navEntrada');
  const navSalida = document.getElementById('navSalida');
  const btnRegistrarEntrada = document.getElementById('btnRegistrarEntrada');
  const btnRegistrarSalida = document.getElementById('btnRegistrarSalida');
  const exportEntradasBtn = document.getElementById('exportEntradasBtn');
  const exportSalidasBtn = document.getElementById('exportSalidasBtn');
  const exportInventarioBtn = document.getElementById('exportInventarioBtn');

  if(role==='admin'){
    navEntrada.classList.remove('disabled'); navSalida.classList.remove('disabled');
    btnRegistrarEntrada.disabled=false; btnRegistrarSalida.disabled=false;
    exportEntradasBtn.disabled=false; exportSalidasBtn.disabled=false; exportInventarioBtn.disabled=false;
    navEntrada.style.display=''; navSalida.style.display='';
  } else {
    navEntrada.classList.add('disabled'); navSalida.classList.add('disabled');
    btnRegistrarEntrada.disabled=true; btnRegistrarSalida.disabled=true;
    exportEntradasBtn.disabled=true; exportSalidasBtn.disabled=true; exportInventarioBtn.disabled=false;
    navEntrada.style.display='none'; navSalida.style.display='none';
  }

  mostrarInventario();
}

/* ===========================
   Funciones Firebase
   =========================== */

// Mostrar inventario (lectura de Firestore)
async function mostrarInventario(){
  const tbody = document.querySelector('#tablaInventario tbody');
  const filterText = (document.getElementById('filterInventario')?.value||'').toLowerCase();
  tbody.innerHTML='';

  try{
    const q = query(collection(db,'articulos'), orderBy('codigo'));
    const snap = await getDocs(q);
    snap.forEach(docSnap=>{
      const a = docSnap.data();
      if(filterText && !(a.codigo.toLowerCase().includes(filterText)||(a.nombre||'').toLowerCase().includes(filterText))) return;
      const tr = document.createElement('tr');
      tr.innerHTML=`<td>${a.codigo}</td><td>${a.nombre}</td><td>${a.stock}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){ console.error(e); showToast('Error cargando inventario','error'); }
}

// Generar código AP###
async function generarCodigo(){
  try{
    const snap = await getDocs(query(collection(db,'articulos'), orderBy('codigo')));
    let max=0;
    snap.forEach(d=>{ const c=d.data().codigo; if(c.startsWith('AP')){ const n=parseInt(c.slice(2),10); if(!isNaN(n) && n>max) max=n; } });
    max++; return 'AP'+String(max).padStart(3,'0');
  }catch(e){ return 'AP'+Math.floor(Math.random()*900+100); }
}

// Registrar Entrada
async function registrarEntrada(e){
  e?.preventDefault();
  if(role!=='admin'){ showToast('No autorizado','error'); return; }
  const codigoInput = document.getElementById('entradaCodigo');
  const nombreInput = document.getElementById('entradaNombre');
  const fechaInput = document.getElementById('entradaFecha');
  const cantidadInput = document.getElementById('entradaCantidad');
  const facturaInput = document.getElementById('entradaFactura');

  let codigo=codigoInput.value.trim();
  const nombre=nombreInput.value.trim();
  const fecha=fechaInput.value;
  const cantidad=parseInt(cantidadInput.value,10);
  const factura=facturaInput.value.trim();

  if(!nombre || !fecha || isNaN(cantidad) || cantidad<=0){ showToast('Complete campos','error'); return; }
  if(new Date(fecha)>new Date()){ showToast('Fecha futura','error'); return; }

  try{
    if(!codigo) codigo = await generarCodigo();
    const artRef = doc(db,'articulos',codigo);
    await runTransaction(db, async tx=>{
      const artSnap = await tx.get(artRef);
      let newStock = cantidad;
      if(artSnap.exists()){ newStock = (artSnap.data().stock||0)+cantidad; tx.update(artRef,{nombre,stock:newStock}); }
      else tx.set(artRef,{codigo,nombre,stock:newStock});
      const mov = { timestamp:new Date().toISOString(), tipo:'Entrada', codigo, nombre, cantidad, fechaMovimiento:fecha, numeroFactura:factura||'', comentario:'', areaEncargado:'', stockResultante:newStock };
      tx.set(doc(collection(db,'movimientos')), mov);
    });
    document.getElementById('formEntrada').reset();
    document.getElementById('entradaFecha').value=new Date().toISOString().split('T')[0];
    mostrarInventario();
    showToast('Entrada registrada','success');
  }catch(e){ console.error(e); showToast('Error registrar entrada','error'); }
}

// Autocompletar salida
async function autocompletarSalida(){
  const code = document.getElementById('salidaCodigo').value.trim();
  if(!code){ document.getElementById('salidaNombre').value=''; document.getElementById('stockActual').textContent=0; return; }
  try{
    const artSnap = await getDoc(doc(db,'articulos',code));
    const art = artSnap.exists()?artSnap.data():null;
    document.getElementById('salidaNombre').value = art?art.nombre:'';
    document.getElementById('stockActual').textContent = art?art.stock:0;
  }catch(e){ console.error(e); }
}

// Registrar salida
async function registrarSalida(e){
  e?.preventDefault();
  if(role!=='admin'){ showToast('No autorizado','error'); return; }
  const codigo = document.getElementById('salidaCodigo').value.trim();
  const area = document.getElementById('salidaArea').value.trim();
  const fecha = document.getElementById('salidaFecha').value;
  const cantidad = parseInt(document.getElementById('salidaCantidad').value,10);
  const comentario = document.getElementById('salidaComentario').value.trim();

  if(!codigo || !area || !fecha || isNaN(cantidad)||cantidad<=0){ showToast('Complete campos','error'); return; }
  if(new Date(fecha)>new Date()){ showToast('Fecha futura','error'); return; }

  try{
    const artRef = doc(db,'articulos',codigo);
    await runTransaction(db, async tx=>{
      const artSnap = await tx.get(artRef);
      if(!artSnap.exists()) throw new Error('Código no existe');
      const newStock = (artSnap.data().stock||0) - cantidad;
      if(newStock<0) throw new Error('Cantidad excede stock');
      tx.update(artRef,{stock:newStock});
      const mov = { timestamp:new Date().toISOString(), tipo:'Salida', codigo, nombre:artSnap.data().nombre, cantidad, fechaMovimiento:fecha, numeroFactura:'', comentario, areaEncargado:area, stockResultante:newStock };
      tx.set(doc(collection(db,'movimientos')), mov);
    });
    document.getElementById('formSalida').reset();
    document.getElementById('salidaFecha').value=new Date().toISOString().split('T')[0];
    document.getElementById('stockActual').textContent=0;
    mostrarInventario();
    showToast('Salida registrada','success');
  }catch(e){ console.error(e); showToast(e.message||'Error registrar salida','error'); }
}

/* ===========================
   Exportar Excel (misma lógica)
   =========================== */
function generarIdMovimiento(){ const now=new Date(); return now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0')+String(now.getSeconds()).padStart(2,'0'); }

window.showTab=showTab;
window.mostrarInventario=mostrarInventario;
window.registrarEntrada=registrarEntrada;
window.autocompletarSalida=autocompletarSalida;
window.registrarSalida=registrarSalida;
</script>
</body>
</html>
