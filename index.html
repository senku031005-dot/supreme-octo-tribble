<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventario - App con Login</title>
<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root{--primary:#860063;--accent:#f78c2a;--bg:#f2f2f2;--card:#fff;--text:#222;--success:#2d862d;--error:#cc0000;}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);min-height:100vh;scroll-behavior:smooth}
/* NAV */
nav{position:sticky;top:0;background:var(--primary);color:#fff;display:flex;gap:8px;padding:10px;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.12);flex-wrap:wrap}
nav button{background:#9a007d;color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;min-width:110px;max-width:170px;flex:1 1 auto;transition:all .18s}
nav button:hover{background:var(--accent)}
nav button.active{background:var(--accent);box-shadow:0 4px 8px rgba(0,0,0,.12)}
nav button.disabled{opacity:.45;cursor:not-allowed;pointer-events:none}
/* CONTAINER */
.container{max-width:920px;margin:16px auto;padding:0 12px 60px}
/* SECTION */
section{display:none;margin-top:12px}
section.active{display:block}
.section-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
.section-head h2{color:var(--primary);font-size:1.2rem}
/* CARD */
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);transition:transform .12s,box-shadow .12s}
.card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
/* FORMS */
label{display:block;font-size:.9rem;margin-bottom:6px;color:#444}
input[type="text"],input[type="number"],input[type="date"],select{width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;margin-bottom:12px;font-size:1rem}
input:focus,select:focus{outline:none;border:2px solid var(--primary)}
button.submitBtn{width:100%;padding:12px;background:var(--primary);color:#fff;border:0;border-radius:10px;cursor:pointer;font-weight:700}
button.exportBtn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
/* STOCK BADGE */
#stockActualCard{display:inline-block;padding:8px 10px;border-radius:10px;background:rgba(247,140,42,.15);font-weight:700;margin-bottom:10px}
/* TABLE */
.table-wrap{overflow:auto;border-radius:10px;border:1px solid #eee}
table{width:100%;border-collapse:collapse;min-width:420px}
thead th{background:var(--primary);color:#fff;padding:10px;text-align:left;font-weight:700}
tbody td{padding:10px;border-bottom:1px solid #f0f0f0}
/* TOAST */
#toast{position:fixed;top:18px;right:18px;z-index:9999;min-width:220px;padding:12px 16px;color:#fff;border-radius:10px;font-weight:700;box-shadow:0 8px 22px rgba(0,0,0,.12);transform:translateY(-20px);opacity:0;transition:all .25s}
#toast.show{transform:translateY(0);opacity:1}
#toast.success{background:var(--success)}
#toast.error{background:var(--error)}
/* LOGIN OVERLAY */
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:10000}
#loginCard{width:96%;max-width:420px;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.35)}
#loginCard h3{color:var(--primary);margin-bottom:12px}
.login-actions{display:flex;gap:10px;margin-top:12px}
.btn-ghost{background:transparent;border:1px solid #ddd;padding:10px;border-radius:8px;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff;border:0;padding:10px;border-radius:8px;cursor:pointer}
@media(max-width:480px){ nav button{max-width:100%} .section-head h2{font-size:1.05rem} th,td{font-size:.95rem} }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay" aria-hidden="false">
  <div id="loginCard" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <h3 id="loginTitle">Inventario — Acceso</h3>
    <input id="loginPassword" type="password" placeholder="Introduce la contraseña">
    <div class="login-actions">
      <button id="btnLogin" class="btn-primary">Entrar</button>
      <button id="btnGuest" class="btn-ghost">Entrar como invitado</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" role="status" aria-live="polite"></div>

<!-- NAV -->
<nav>
  <button id="navInventario" onclick="showTab('inventario')">Inventario</button>
  <button id="navEntrada" onclick="showTab('entrada')">Entrada</button>
  <button id="navSalida" onclick="showTab('salida')">Salida</button>
</nav>

<div class="container">

  <!-- INVENTARIO -->
  <section id="inventario">
    <div class="section-head">
      <h2>Inventario Actual</h2>
      <button class="exportBtn" onclick="exportarExcel('inventario')">Exportar Inventario</button>
    </div>
    <div class="card">
      <div class="table-wrap" style="max-height:420px;overflow:auto">
        <table id="tablaInventario">
          <thead><tr><th>Código</th><th>Nombre</th><th>Stock</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ENTRADA -->
  <section id="entrada">
    <div class="section-head">
      <h2>Entrada de Artículo</h2>
      <button class="exportBtn" onclick="exportarExcel('entrada')">Exportar Entradas</button>
    </div>
    <div class="card">
      <form id="formEntrada">
        <label>Código (si es nuevo, se genera automático)</label>
        <input id="entradaCodigo" type="text">
        <label>Nombre *</label>
        <input id="entradaNombre" type="text" required>
        <label>Fecha *</label>
        <input id="entradaFecha" type="date" required>
        <label>Cantidad *</label>
        <input id="entradaCantidad" type="number" min="1" required>
        <label>Factura</label>
        <input id="entradaFactura" type="text">
        <button type="submit" class="submitBtn">Registrar Entrada</button>
      </form>
    </div>
  </section>

  <!-- SALIDA -->
  <section id="salida">
    <div class="section-head">
      <h2>Salida de Artículo</h2>
      <button class="exportBtn" onclick="exportarExcel('salida')">Exportar Salidas</button>
    </div>
    <div class="card">
      <form id="formSalida">
        <label>Código *</label>
        <input id="salidaCodigo" type="text" required>
        <label>Nombre</label>
        <input id="salidaNombre" type="text" readonly>
        <div id="stockActualCard">Stock actual: <span id="stockActual">0</span></div>
        <label>Área/Encargado *</label>
        <input id="salidaArea" type="text" required>
        <label>Fecha *</label>
        <input id="salidaFecha" type="date" required>
        <label>Cantidad *</label>
        <input id="salidaCantidad" type="number" min="1" required>
        <label>Comentario</label>
        <input id="salidaComentario" type="text">
        <button type="submit" class="submitBtn">Registrar Salida</button>
      </form>
    </div>
  </section>

</div>

<script>
let role='locked';
const toast=document.getElementById('toast');
function showToast(msg,type='success'){toast.textContent=msg;toast.className='show '+(type==='error'?'error':'success');setTimeout(()=>{toast.className='';},3000);}
const ADMIN_PASSWORD='ofi123';

// LOGIN
document.getElementById('btnLogin').onclick=()=>{
  const pwd=document.getElementById('loginPassword').value;
  if(pwd===ADMIN_PASSWORD){ role='admin'; document.getElementById('loginOverlay').style.display='none'; initApp(); showToast('Bienvenido Admin');}
  else showToast('Contraseña incorrecta','error');
}
document.getElementById('btnGuest').onclick=()=>{
  role='guest'; document.getElementById('loginOverlay').style.display='none'; initApp(); showToast('Modo Invitado');
}

// NAV
function showTab(tab){
  if(role==='guest' && (tab==='entrada'||tab==='salida')){ showToast('Acceso denegado','error'); tab='inventario'; }
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
}

// LOCALSTORAGE DATA
function getData(key){ return JSON.parse(localStorage.getItem(key)||'[]'); }
function setData(key,data){ localStorage.setItem(key,JSON.stringify(data)); }

// INIT APP
function initApp(){
  showTab('inventario');
  mostrarInventario();
  document.getElementById('formEntrada').onsubmit=registrarEntrada;
  document.getElementById('formSalida').onsubmit=registrarSalida;
  document.getElementById('salidaCodigo').oninput=autocompletarSalida;
}

// INVENTARIO
function mostrarInventario(){
  const tbody=document.querySelector('#tablaInventario tbody');
  tbody.innerHTML='';
  const inventario=getData('articulos');
  inventario.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.codigo}</td><td>${a.nombre}</td><td>${a.stock}</td>`;
    tbody.appendChild(tr);
  });
}

// GENERAR CODIGO
function generarCodigo(){
  const inventario=getData('articulos');
  let max=0; inventario.forEach(a=>{ const n=parseInt(a.codigo.slice(2)); if(!isNaN(n) && n>max) max=n; });
  return 'AP'+String(max+1).padStart(3,'0');
}

// REGISTRAR ENTRADA
function registrarEntrada(e){
  e.preventDefault();
  if(role!=='admin'){ showToast('No autorizado','error'); return; }
  let codigo=document.getElementById('entradaCodigo').value.trim();
  const nombre=document.getElementById('entradaNombre').value.trim();
  const fecha=document.getElementById('entradaFecha').value;
  const cantidad=parseInt(document.getElementById('entradaCantidad').value);
  const factura=document.getElementById('entradaFactura').value.trim();
  if(!nombre||!fecha||isNaN(cantidad)||cantidad<=0){ showToast('Complete todos los campos','error'); return; }
  if(!codigo) codigo=generarCodigo();
  const inventario=getData('articulos');
  let articulo=inventario.find(a=>a.codigo===codigo);
  if(articulo) articulo.stock+=cantidad;
  else inventario.push({codigo,nombre,stock:cantidad});
  setData('articulos',inventario);
  // Guardar movimiento
  const movimientos=getData('movimientos'); movimientos.push({tipo:'Entrada',codigo,nombre,cantidad,fecha,numeroFactura:factura,comentario:'',areaEncargado:'',stockResultante:articulo?articulo.stock:cantidad});
  setData('movimientos',movimientos);
  showToast('Entrada registrada');
  document.getElementById('formEntrada').reset();
  mostrarInventario();
}

// AUTOCOMPLETAR SALIDA
function autocompletarSalida(){
  const codigo=document.getElementById('salidaCodigo').value.trim();
  const inventario=getData('articulos');
  const art=inventario.find(a=>a.codigo===codigo);
  document.getElementById('salidaNombre').value=art?art.nombre:'';
  document.getElementById('stockActual').textContent=art?art.stock:0;
}

// REGISTRAR SALIDA
function registrarSalida(e){
  e.preventDefault();
  if(role!=='admin'){ showToast('No autorizado','error'); return; }
  const codigo=document.getElementById('salidaCodigo').value.trim();
  const area=document.getElementById('salidaArea').value.trim();
  const fecha=document.getElementById('salidaFecha').value;
  const cantidad=parseInt(document.getElementById('salidaCantidad').value);
  const comentario=document.getElementById('salidaComentario').value.trim();
  if(!codigo||!area||!fecha||isNaN(cantidad)||cantidad<=0){ showToast('Complete todos los campos','error'); return; }
  const inventario=getData('articulos'); const art=inventario.find(a=>a.codigo===codigo);
  if(!art){ showToast('Artículo no existe','error'); return; }
  if(cantidad>art.stock){ showToast('Stock insuficiente','error'); return; }
  art.stock-=cantidad;
  setData('articulos',inventario);
  const movimientos=getData('movimientos'); movimientos.push({tipo:'Salida',codigo,areaEncargado:area,fechaMovimiento:fecha,cantidad,comentario,stockResultante:art.stock,nombre:art.nombre});
  setData('movimientos',movimientos);
  showToast('Salida registrada');
  document.getElementById('formSalida').reset();
  document.getElementById('stockActual').textContent=art.stock;
  mostrarInventario();
}

// EXPORTAR EXCEL
function exportarExcel(tipo){
  let data=[];
  if(tipo==='inventario') data=getData('articulos');
  else data=getData('movimientos').filter(m=>tipo==='entrada'?m.tipo==='Entrada':m.tipo==='Salida');
  if(data.length===0){ showToast('No hay datos para exportar','error'); return; }
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Datos');
  XLSX.writeFile(wb,`${tipo}_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>

</body>
</html>
